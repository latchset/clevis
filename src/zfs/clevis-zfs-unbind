#!/bin/bash
set -euo pipefail

. clevis-zfs-common

SUMMARY="Unbinds a ZFS dataset (remove clevis)"



function usage() {
	cat >&2 <<-USAGE_END
		Usage: clevis zfs unbind [-k KEY] -d DEV

		$SUMMARY:

		  -d DEV  The zfs dataset on which to perform binding

		  -k KEY  Non-interactively read zfs password from KEY file
		  -k -    Non-interactively read zfs password from standard input

	USAGE_END
}


function main() {
	if [ $# -eq 1 -a "${1:-}" == "--summary" ]; then
		echo "$SUMMARY"
		exit 0
	fi

	local dataset=
	local key=
	while getopts ":hfd:k:" o; do
		case "$o" in
		d) dataset="$OPTARG";;
		k) key="$OPTARG";;
		*) error "unrecognized argument: -${OPTARG}";;
		esac
	done

	if [ -z "${dataset:-""}" ]; then
		error "did not specify a device!"
	fi

	if ! zfs_is_bound "${dataset}"; then
		error "dataset is not bound with clevis: ${dataset}"
	fi

	echo >&2 "Loading existing key... "
	local existing_key="$(load_key "${dataset}" "${key}")"

	if ! zfs_test_key "${dataset}" <<<"${existing_key}"; then
		error "given key does not unlock ${dataset}"
	fi

	echo >&2 -n 'wiping clevis data... '
	zfs_wipe_clevis_data "${dataset}"
	echo >&2 'ok'
}
main "${@}"
